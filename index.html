<html>
<head>
    <title>Demo: Processing of HLS Stream</title>
    <script src="https://hls-js.netlify.app/dist/hls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
            integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
            crossorigin="anonymous"></script>
</head>

<body style="background: rgba(128,128,128,0.1)">

<div class="container" style="margin: 0; max-width: 100%">
    <div class="row" style="margin-top: 5px">
        <div class="col-md-8" id="video-div">
            <video id="video" style="width: 100%" controls></video>
            <div class="input-group mb-3" style="margin-top: 10px">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                        <input type="checkbox" aria-label="Highlight Speaker" id="highlightState">
                    </div>
                </div>
                <input type="text" class="form-control" placeholder="Stream link"
                       style="background: rgba(128,128,128,0.11)"
                       id="url">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="set_url">Apply</button>
                </div>
            </div>
        </div>
        <div id="subtitles-div" class="col-md-4" style="overflow-y: auto;">
            <p id="subtitles"></p>
        </div>
    </div>
    <div class="row">
        <div id="charts" style="width: 100%">
            <div style="height: 250px; width: 14%; float: left">
                <canvas id="happy" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 14%; float: left">
                <canvas id="angry" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 14%; float: left">
                <canvas id="disgust" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 14%; float: left">
                <canvas id="fear" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 14%; float: left">
                <canvas id="sad" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 14%; float: left">
                <canvas id="surprise" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 14%; float: left">
                <canvas id="neutral" style="height: 100%; width: 100%"></canvas>
            </div>
        </div>
    </div>
</div>

</body>

<script>
    let happy;
    let angry;
    let disgust;
    let fear;
    let sad;
    let surprise;
    let neutral;

    let text = [];
    let emotions = [];

    let speakerTimeline = [];

    if (Hls.isSupported()) {
        let video = document.getElementById('video');
        document.getElementById('subtitles-div').style.maxHeight = document.getElementById('video-div').clientHeight + 'px';
        let hls = new Hls();
        hls.loadSource('https://storage.googleapis.com/otopia_audio/conanZoom/ConanZoom.m3u8');
        hls.attachMedia(video);
        loadJSON('jdata.json', function (json) {
            let results = JSON.parse(json);
            let currentFrame = 0;
            let currentData = [];
            for (let i = 0; i < results.length; i++) {
                currentFrame++;
                if (currentFrame === 15) {     // display emotions on the chart for each 15th frame only to reduce load
                    let clusteredEmotions = {
                        angry: 0,
                        disgust: 0,
                        fear: 0,
                        happy: 0,
                        sad: 0,
                        surprise: 0,
                        neutral: 0
                    };
                    for (let frameId = 0; frameId < currentData.length; frameId++) {
                        clusteredEmotions.angry += currentData[frameId].angry;
                        clusteredEmotions.disgust += currentData[frameId].disgust;
                        clusteredEmotions.fear += currentData[frameId].fear;
                        clusteredEmotions.happy += currentData[frameId].happy;
                        clusteredEmotions.sad += currentData[frameId].sad;
                        clusteredEmotions.surprise += currentData[frameId].surprise;
                        clusteredEmotions.neutral += currentData[frameId].neutral;
                    }

                    let counter = {
                        angry: 0,
                        disgust: 0,
                        fear: 0,
                        happy: 0,
                        sad: 0,
                        surprise: 0,
                        neutral: 0
                    }
                    for (let j = 0; j < currentData.length; j++) {
                        counter.angry += currentData[j].angry > 0 ? 1 : 0;
                        counter.disgust += currentData[j].disgust > 0 ? 1 : 0;
                        counter.fear += currentData[j].fear > 0 ? 1 : 0;
                        counter.happy += currentData[j].happy > 0 ? 1 : 0;
                        counter.sad += currentData[j].sad > 0 ? 1 : 0;
                        counter.surprise += currentData[j].surprise > 0 ? 1 : 0;
                        counter.neutral += currentData[j].neutral > 0 ? 1 : 0;
                    }
                    clusteredEmotions.angry = clusteredEmotions.angry > 0 ? clusteredEmotions.angry / counter.angry : 0;
                    clusteredEmotions.disgust = clusteredEmotions.disgust > 0 ? clusteredEmotions.disgust / counter.disgust : 0
                    clusteredEmotions.fear = clusteredEmotions.fear > 0 ? clusteredEmotions.fear / counter.fear : 0
                    clusteredEmotions.happy = clusteredEmotions.happy > 0 ? clusteredEmotions.happy / counter.happy : 0
                    clusteredEmotions.sad = clusteredEmotions.sad > 0 ? clusteredEmotions.sad / counter.sad : 0
                    clusteredEmotions.surprise = clusteredEmotions.surprise > 0 ? clusteredEmotions.surprise / counter.surprise : 0
                    clusteredEmotions.neutral = clusteredEmotions.neutral > 0 ? clusteredEmotions.neutral / counter.neutral : 0
                    emotions.push({
                        original: results[i].frame[0].ts.substring(3, results[i].frame[0].ts.length),
                        ts: parseTs(results[i].frame[0].ts),
                        data: clusteredEmotions
                    });
                    currentFrame = 0
                    currentData = []
                } else {
                    currentData.push(results[i].emotions[0])
                }
            }
        });

        function parseTs(ts) {
            let splitted = ts.split(':');
            let minutes = parseFloat(splitted[1].replace('0', ''));
            let tempSec = splitted[2].split('.');
            let seconds = parseFloat(tempSec[0].replace('0', ''));
            let milliseconds = parseFloat(tempSec[1].slice(0, -1));
            return parseFloat((minutes * 60 + seconds) + '.' + milliseconds);
        }

        loadJSON('ConanZoomTranscript.json', function (json) {
            let results = JSON.parse(json).response.results;
            let alternatives = results[results.length - 1].alternatives;
            for (let alternativeIndex = 0; alternativeIndex < alternatives.length; alternativeIndex++) {
                let words = alternatives[alternativeIndex].words;
                for (let wordIndex = 0; wordIndex < words.length; wordIndex++) {
                    text.push({
                        startTime: parseFloat(words[wordIndex].startTime.replace('s', '')),
                        endTime: parseFloat(words[wordIndex].endTime.replace('s', '')),
                        word: words[wordIndex].word,
                        speakerTag: words[wordIndex].speakerTag === undefined ? 100 : words[wordIndex].speakerTag
                    });
                }
            }
            loadJSON('speakers.json', function (json) {
                speakerTimeline = JSON.parse(json)
                for (let i = 0; i < text.length; i++) {
                    for (let j = 0; j < speakerTimeline.length; j++) {
                        if (speakerTimeline[j].Start <= text[i].startTime && speakerTimeline[j].End >= text[i].endTime) {
                            text[i].name = speakerTimeline[j].Name
                            j = speakerTimeline.length
                        }
                    }
                    if (text[i].name == null) {
                        text[i].name = text[i - 1].name
                    }
                }
            })
        })
        hls.on(Hls.Events.MANIFEST_PARSED, function () {
            video.play();
        });
    } else {
        alert("HLS is not supported in your browser")
    }

    let btn = document.getElementById('set_url');
    btn.addEventListener('click', function () {
        let hls = new Hls();
        hls.loadSource(document.getElementById('url').value);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function () {
            video.play();
        });
    }, false);

    let subtitles = document.getElementById('subtitles');

    let lastAddedTsToChart = -1;

    window.setInterval(function () {
        let video = document.getElementById('video');
        if (emotions.length !== 0) {
            let currentTime = parseFloat(video.currentTime);
            let minTime = (currentTime - 20) > 0 ? currentTime - 20 : 0;
            for (let i = 0; i < emotions.length; i++) {
                if (currentTime > emotions[i].ts && minTime < emotions[i].ts && lastAddedTsToChart < emotions[i].ts) {
                    happy.data.datasets[0].data.push(emotions[i].data.happy)
                    happy.data.labels.push(emotions[i].original)

                    angry.data.datasets[0].data.push(emotions[i].data.angry)
                    angry.data.labels.push(emotions[i].original)

                    disgust.data.datasets[0].data.push(emotions[i].data.disgust)
                    disgust.data.labels.push(emotions[i].original)

                    fear.data.datasets[0].data.push(emotions[i].data.disgust)
                    fear.data.labels.push(emotions[i].original)

                    sad.data.datasets[0].data.push(emotions[i].data.sad)
                    sad.data.labels.push(emotions[i].original)

                    surprise.data.datasets[0].data.push(emotions[i].data.surprise)
                    surprise.data.labels.push(emotions[i].original)

                    neutral.data.datasets[0].data.push(emotions[i].data.neutral)
                    neutral.data.labels.push(emotions[i].original)

                    lastAddedTsToChart = emotions[i].ts
                    happy.update()
                    angry.update()
                    disgust.update()
                    fear.update()
                    sad.update()
                    surprise.update()
                    neutral.update()
                }
            }
        }
        document.getElementById('subtitles-div').style.maxHeight = document.getElementById('video-div').clientHeight + 'px'
    }, 300);

    let scrollHeight = 0
    let prevTime = -1

    window.setInterval(function () {
        let video = document.getElementById('video');
        let currentTime = parseFloat(video.currentTime);
        if (currentTime === prevTime) {
            return
        }
        if (text.length !== 0 && document.getElementById('highlightState').checked) {
            subtitles.innerText = ''
            let speakerTag = text[0].name
            let speakerText = ''
            let side = 'left'
            for (let index = 0; index < text.length; index++) {
                if (text[index].endTime <= currentTime) {
                    if (speakerTag === text[index].name) {
                        speakerText += text[index].word + ' '
                    } else {
                        subtitles.innerHTML += '<p class="alert alert-secondary" style="width: 80%; float: ' + side + '">' + speakerText + '</p>'
                        side = side === 'left' ? 'right' : 'left'
                        speakerText = text[index].word + ' '
                    }
                    speakerTag = text[index].name
                }
            }
            if (speakerText !== '') {
                subtitles.innerHTML += '<p class="alert alert-secondary" style="width: 80%; float: ' + side + '">' + speakerText + '</p>'
            }
        } else if (text.length !== 0) {
            let foundText = null;
            let currentTime = parseFloat(video.currentTime);
            let line = '';
            subtitles.innerText = '';
            for (let index = 0; index < text.length; index++) {
                if (text[index].endTime <= currentTime) {
                    foundText = text[index].word;
                    line += ' ' + foundText;
                }
            }
            subtitles.innerText = line;
        }
        prevTime = currentTime;
        let subtitlesContainer = document.getElementById('subtitles-div');
        if (scrollHeight !== subtitlesContainer.scrollHeight) {
            subtitlesContainer.scrollTop = subtitlesContainer.scrollHeight
            scrollHeight = subtitlesContainer.scrollHeight
        }
    }, 100)

    function loadJSON(filename, callback) {
        let xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
        xobj.open('GET', filename, true);
        xobj.onreadystatechange = function () {
            if (xobj.readyState == 4 && xobj.status == "200") {
                callback(xobj.responseText);
            }
        };
        xobj.send(null);
    }

    happy = createChart('happy', 'Happy', 'rgb(162,255,127)')
    angry = createChart('angry', 'Angry', 'rgb(144,0,32)')
    disgust = createChart('disgust', 'Disgust', 'rgb(238,133,6)')
    fear = createChart('fear', 'Fear', 'rgb(182,180,180)')
    sad = createChart('sad', 'Sad', 'rgb(59,0,118)')
    surprise = createChart('surprise', 'Surprise', 'rgb(9,196,213)')
    neutral = createChart('neutral', 'Neutral', 'rgb(215,23,206)')

    function createChart(id, name, color) {
        let ctx = document.getElementById(id).getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    borderColor: color,
                    data: []
                }]
            },
            options: {
                title: {
                    display: true,
                    text: name
                },
                legend: {
                    display: false
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    }
</script>
</html>