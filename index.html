<html>
<head>
    <title>Demo</title>
    <script src="https://hls-js.netlify.app/dist/hls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
            integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
            crossorigin="anonymous"></script>
</head>

<body style="background: rgba(128,128,128,0.1)">

<div class="container" style="margin: 0; max-width: 100%">
    <div class="row" style="margin-top: 5px">
        <div class="col-md-8" id="video-div">
            <video id="video" style="width: 100%" controls></video>
            <div class="input-group mb-3" style="margin-top: 10px">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                        <input type="checkbox" aria-label="Highlight Speaker" id="highlightState" checked>
                    </div>
                </div>
                <input type="text" class="form-control" placeholder="Stream link"
                       style="background: rgba(128,128,128,0.11)"
                       id="url"/>
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="set_url">Apply</button>
                </div>
            </div>
        </div>
        <div id="subtitles-div" class="col-md-4" style="overflow-y: auto;">
            <p id="subtitles"></p>
        </div>
    </div>
    <div class="row">
        <div id="charts" style="width: 100%">
            <div style="height: 250px; width: 11.1%; float: left">
                <canvas id="mark" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 11.1%; float: left">
                <canvas id="adam" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 11.1%; float: left">
                <canvas id="alan" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 11.1%; float: left">
                <canvas id="terry" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 11.1%; float: left">
                <canvas id="molly" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 11.1%; float: left">
                <canvas id="damon" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 11.1%; float: left">
                <canvas id="becky" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 11.1%; float: left">
                <canvas id="dan" style="height: 100%; width: 100%"></canvas>
            </div>
            <div style="height: 250px; width: 11.1%; float: left">
                <canvas id="conan" style="height: 100%; width: 100%"></canvas>
            </div>
        </div>
    </div>
</div>

</body>

<script>
    let mark;
    let adam;
    let alan;
    let terry;
    let molly;
    let damon;
    let becky;
    let dan;
    let conan;

    let text = [];
    let emotions = [];

    let speakerTimeline = [];

    if (Hls.isSupported()) {
        let video = document.getElementById('video');
        document.getElementById('subtitles-div').style.maxHeight = document.getElementById('video-div').clientHeight + 'px';
        let hls = new Hls();
        hls.loadSource('https://storage.googleapis.com/otopia_audio/conanZoom/ConanZoom.m3u8');
        hls.attachMedia(video);
        loadJSON('newjdata.json', function (json) {
            let results = JSON.parse(json);
            let currentFrame = 0;
            let currentData = [];
            for (let i = 0; i < results.length; i++) {
                if (results[i].face.length === 0) {
                    continue
                }
                currentFrame++;
                if (currentFrame === 15) {
                    let cluster = {}
                    for (let j = 0; j < currentData.length; j++) {
                        let names = Object.keys(currentData[j])
                        for (let k = 0; k < names.length; k++) {
                            let emotion = currentData[j][names[k]].emotion
                            let value = currentData[j][names[k]].value
                            if (cluster[names[k]] !== undefined) {
                                if (!isNaN(value)) {
                                    if (cluster[names[k]][emotion] !== undefined) {
                                        cluster[names[k]][emotion] = parseInt(cluster[names[k]][emotion]) + parseInt(value)
                                    } else {
                                        cluster[names[k]][emotion] = parseInt(value)
                                    }
                                }
                            } else {
                                cluster[names[k]] = {
                                    angry: 0,
                                    disgust: 0,
                                    fear: 0,
                                    happy: 0,
                                    sad: 0,
                                    surprise: 0,
                                    neutral: 0
                                };
                                if (!isNaN(value)) {
                                    cluster[names[k]][emotion] = value
                                }
                            }
                        }
                    }
                    emotions.push({
                        original: results[i].frame[0].ts.substring(3, results[i].frame[0].ts.length),
                        ts: parseTs(results[i].frame[0].ts),
                        data: cluster
                    });
                    currentFrame = 0
                    currentData = []
                } else {
                    let participants = {};
                    for (let j = 0; j < results[i].face.length; j++) {
                        let participant = results[i].face[j].name
                        let participantEmotions = results[i].face[j].emotions
                        if (participants[participantEmotions] !== undefined) {
                            participants[participantEmotions].push(participant)
                        } else {
                            participants[participantEmotions] = []
                            participants[participantEmotions].push(participant)
                        }
                    }

                    let frameEmotions = Object.keys(participants)
                    let emotions = {}
                    for (let j = 0; j < frameEmotions.length; j++) {
                        let emotion = frameEmotions[j]
                        let names = participants[emotion]
                        let avgEmo = parseInt(results[i].emotions[0][emotion]) / names.length
                        for (let k = 0; k < names.length; k++) {
                            emotions[names[k]] = {
                                emotion: emotion,
                                value: avgEmo
                            };
                        }
                    }
                    currentData.push(emotions)
                }
            }
        });

        function parseTs(ts) {
            let splitted = ts.split(':');
            let minutes = parseFloat(splitted[1].replace('0', ''));
            let tempSec = splitted[2].split('.');
            let seconds = parseFloat(tempSec[0].replace('0', ''));
            let milliseconds = parseFloat(tempSec[1].slice(0, -1));
            return parseFloat((minutes * 60 + seconds) + '.' + milliseconds);
        }

        loadJSON('ConanZoomTranscript.json', function (json) {
            let results = JSON.parse(json).response.results;
            let alternatives = results[results.length - 1].alternatives;
            for (let alternativeIndex = 0; alternativeIndex < alternatives.length; alternativeIndex++) {
                let words = alternatives[alternativeIndex].words;
                for (let wordIndex = 0; wordIndex < words.length; wordIndex++) {
                    text.push({
                        startTime: parseFloat(words[wordIndex].startTime.replace('s', '')),
                        endTime: parseFloat(words[wordIndex].endTime.replace('s', '')),
                        word: words[wordIndex].word,
                        speakerTag: words[wordIndex].speakerTag === undefined ? 100 : words[wordIndex].speakerTag
                    });
                }
            }
            loadJSON('speakers.json', function (json) {
                speakerTimeline = JSON.parse(json)
                for (let i = 0; i < text.length; i++) {
                    for (let j = 0; j < speakerTimeline.length; j++) {
                        if (speakerTimeline[j].Start <= text[i].startTime && speakerTimeline[j].End >= text[i].endTime) {
                            text[i].name = speakerTimeline[j].Name
                            text[i].color = speakerTimeline[j].Color
                            j = speakerTimeline.length
                        }
                    }
                    if (text[i].name == null) {
                        text[i].name = text[i - 1].name
                        text[i].color = text[i - 1].Color
                    }
                }
            })
        })
        hls.on(Hls.Events.MANIFEST_PARSED, function () {
            video.play();
        });
    } else {
        alert("HLS is not supported in your browser")
    }

    let btn = document.getElementById('set_url');
    btn.addEventListener('click', function () {
        let hls = new Hls();
        hls.loadSource(document.getElementById('url').value);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function () {
            video.play();
        });
    }, false);

    let subtitles = document.getElementById('subtitles');

    let lastAddedTsToChart = -1;

    window.setInterval(function () {
        let video = document.getElementById('video');
        if (emotions.length !== 0) {
            let currentTime = parseFloat(video.currentTime);
            let minTime = (currentTime - 20) > 0 ? currentTime - 20 : 0;
            for (let i = 0; i < emotions.length; i++) {
                if (currentTime > emotions[i].ts && minTime < emotions[i].ts && lastAddedTsToChart < emotions[i].ts) {
                    if (emotions[i].data['Mark'] !== undefined) {
                        mark.data.datasets[0].data.push(emotions[i].data['Mark']['happy'])
                        mark.data.datasets[1].data.push(emotions[i].data['Mark']['angry'])
                        mark.data.datasets[2].data.push(emotions[i].data['Mark']['disgust'])
                        mark.data.datasets[3].data.push(emotions[i].data['Mark']['sad'])
                        mark.data.datasets[4].data.push(emotions[i].data['Mark']['surprise'])
                        mark.data.datasets[5].data.push(emotions[i].data['Mark']['neutral'])
                        mark.data.labels.push(emotions[i].original)

                        mark.update()
                    }

                    if (emotions[i].data['Adam'] !== undefined) {
                        adam.data.datasets[0].data.push(emotions[i].data['Adam']['happy'])
                        adam.data.datasets[1].data.push(emotions[i].data['Adam']['angry'])
                        adam.data.datasets[2].data.push(emotions[i].data['Adam']['disgust'])
                        adam.data.datasets[3].data.push(emotions[i].data['Adam']['sad'])
                        adam.data.datasets[4].data.push(emotions[i].data['Adam']['surprise'])
                        adam.data.datasets[5].data.push(emotions[i].data['Adam']['neutral'])
                        adam.data.labels.push(emotions[i].original)

                        adam.update()
                    }

                    if (emotions[i].data['Alan'] !== undefined) {
                        alan.data.datasets[0].data.push(emotions[i].data['Alan']['happy'])
                        alan.data.datasets[1].data.push(emotions[i].data['Alan']['angry'])
                        alan.data.datasets[2].data.push(emotions[i].data['Alan']['disgust'])
                        alan.data.datasets[3].data.push(emotions[i].data['Alan']['sad'])
                        alan.data.datasets[4].data.push(emotions[i].data['Alan']['surprise'])
                        alan.data.datasets[5].data.push(emotions[i].data['Alan']['neutral'])
                        alan.data.labels.push(emotions[i].original)

                        alan.update()
                    }

                    if (emotions[i].data['Alan'] !== undefined) {
                        terry.data.datasets[0].data.push(emotions[i].data['Terry']['happy'])
                        terry.data.datasets[1].data.push(emotions[i].data['Terry']['angry'])
                        terry.data.datasets[2].data.push(emotions[i].data['Terry']['disgust'])
                        terry.data.datasets[3].data.push(emotions[i].data['Terry']['sad'])
                        terry.data.datasets[4].data.push(emotions[i].data['Terry']['surprise'])
                        terry.data.datasets[5].data.push(emotions[i].data['Terry']['neutral'])
                        terry.data.labels.push(emotions[i].original)

                        terry.update()
                    }

                    if (emotions[i].data['Molly'] !== undefined) {
                        molly.data.datasets[0].data.push(emotions[i].data['Molly']['happy'])
                        molly.data.datasets[1].data.push(emotions[i].data['Molly']['angry'])
                        molly.data.datasets[2].data.push(emotions[i].data['Molly']['disgust'])
                        molly.data.datasets[3].data.push(emotions[i].data['Molly']['sad'])
                        molly.data.datasets[4].data.push(emotions[i].data['Molly']['surprise'])
                        molly.data.datasets[5].data.push(emotions[i].data['Molly']['neutral'])
                        molly.data.labels.push(emotions[i].original)

                        molly.update()
                    }

                    if (emotions[i].data['Damon'] !== undefined) {
                        damon.data.datasets[0].data.push(emotions[i].data['Damon']['happy'])
                        damon.data.datasets[1].data.push(emotions[i].data['Damon']['angry'])
                        damon.data.datasets[2].data.push(emotions[i].data['Damon']['disgust'])
                        damon.data.datasets[3].data.push(emotions[i].data['Damon']['sad'])
                        damon.data.datasets[4].data.push(emotions[i].data['Damon']['surprise'])
                        damon.data.datasets[5].data.push(emotions[i].data['Damon']['neutral'])
                        damon.data.labels.push(emotions[i].original)

                        damon.update()
                    }

                    if (emotions[i].data['Becky'] !== undefined) {
                        becky.data.datasets[0].data.push(emotions[i].data['Becky']['happy'])
                        becky.data.datasets[1].data.push(emotions[i].data['Becky']['angry'])
                        becky.data.datasets[2].data.push(emotions[i].data['Becky']['disgust'])
                        becky.data.datasets[3].data.push(emotions[i].data['Becky']['sad'])
                        becky.data.datasets[4].data.push(emotions[i].data['Becky']['surprise'])
                        becky.data.datasets[5].data.push(emotions[i].data['Becky']['neutral'])
                        becky.data.labels.push(emotions[i].original)

                        becky.update()
                    }

                    if (emotions[i].data['Dan'] !== undefined) {
                        dan.data.datasets[0].data.push(emotions[i].data['Dan']['happy'])
                        dan.data.datasets[1].data.push(emotions[i].data['Dan']['angry'])
                        dan.data.datasets[2].data.push(emotions[i].data['Dan']['disgust'])
                        dan.data.datasets[3].data.push(emotions[i].data['Dan']['sad'])
                        dan.data.datasets[4].data.push(emotions[i].data['Dan']['surprise'])
                        dan.data.datasets[5].data.push(emotions[i].data['Dan']['neutral'])
                        dan.data.labels.push(emotions[i].original)

                        dan.update()
                    }

                    lastAddedTsToChart = emotions[i].ts
                }
            }
        }
        document.getElementById('subtitles-div').style.maxHeight = document.getElementById('video-div').clientHeight + 'px'
    }, 300);

    let scrollHeight = 0
    let prevTime = -1

    window.setInterval(function () {
        let video = document.getElementById('video');
        let currentTime = parseFloat(video.currentTime);
        if (currentTime === prevTime) {
            return
        }
        if (text.length !== 0 && document.getElementById('highlightState').checked) {
            subtitles.innerText = ''
            let speakerTag = text[0].name
            let speakerColor = text[0].color
            let speakerTime = text[0].startTime
            let speakerText = ''
            let side = 'left'
            for (let index = 0; index < text.length; index++) {
                if (text[index].endTime <= currentTime) {
                    if (speakerTag === text[index].name) {
                        speakerText += text[index].word + ' '
                    } else {
                        subtitles.innerHTML +=
                            '<div class="alert alert-secondary" ' +
                            'style="max-width: 80%; margin-bottom: 5px; background: white; border: none; line-height: normal; float: ' + side + '">' +
                            '<div style="color: ' + speakerColor + '!important; margin-bottom: 5px">' + speakerTag + '</div>' +
                            '<div> ' + speakerText + '</div>' +
                            '<div style="font-size: smaller; color: grey; float: right; margin-right: -10px; margin-top: 3px">' + getSeconds(speakerTime) + '</div>' +
                            '</div>'
                        subtitles.innerHTML += '<div style="width: 100%; margin: 0; float: ' + side + '"></div>'
                        side = side === 'left' ? 'right' : 'left'
                        speakerText = text[index].word + ' '
                        speakerTime = text[index].startTime
                    }
                    speakerColor = text[index].color
                    speakerTag = text[index].name
                }
            }
            if (speakerText !== '') {
                subtitles.innerHTML +=
                    '<div class="alert alert-secondary" ' +
                    'style="max-width: 80%; margin-bottom: 5px; background: white; border: none; line-height: normal; float: ' + side + '">' +
                    '<div style="color: ' + speakerColor + '!important; margin-bottom: 5px">' + speakerTag + '</div>' +
                    '<div> ' + speakerText + '</div>' +
                    '<div style="font-size: smaller; color: grey; float: right; margin-right: -10px; margin-top: 3px">' + getSeconds(speakerTime) + '</div>' +
                    '</div>'
                subtitles.innerHTML += '<div style="width: 100%; margin: 0; float: ' + side + '"></div>'
            }
        } else if (text.length !== 0) {
            let foundText = null;
            let currentTime = parseFloat(video.currentTime);
            let line = '';
            subtitles.innerText = '';
            for (let index = 0; index < text.length; index++) {
                if (text[index].endTime <= currentTime) {
                    foundText = text[index].word;
                    line += ' ' + foundText;
                }
            }
            subtitles.innerText = line;
        }
        prevTime = currentTime;
        let subtitlesContainer = document.getElementById('subtitles-div');
        if (scrollHeight !== subtitlesContainer.scrollHeight) {
            subtitlesContainer.scrollTop = subtitlesContainer.scrollHeight
            scrollHeight = subtitlesContainer.scrollHeight
        }
    }, 100)

    function getSeconds(value) {
        if (value > 60) {
            let minutes = Math.floor(value / 60)
            let seconds = (value - (minutes * 60).toFixed(0)).toFixed(0)
            return '0' + minutes + ':' + (seconds > 10 ? seconds : '0' + seconds);
        }
        return '00:' + (value > 10 ? value.toFixed(0) : '0' + value.toFixed(0))
    }

    function loadJSON(filename, callback) {
        let xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
        xobj.open('GET', filename, true);
        xobj.onreadystatechange = function () {
            if (xobj.readyState == 4 && xobj.status == "200") {
                callback(xobj.responseText);
            }
        };
        xobj.send(null);
    }

    mark = createChart('mark', 'Mark', 'rgb(162,255,127)')
    adam = createChart('adam', 'Adam', 'rgb(144,0,32)')
    alan = createChart('alan', 'Alan', 'rgb(238,133,6)')
    terry = createChart('terry', 'Terry', 'rgb(182,180,180)')
    molly = createChart('molly', 'Molly', 'rgb(59,0,118)')
    damon = createChart('damon', 'Damon', 'rgb(9,196,213)')
    becky = createChart('becky', 'Becky', 'rgb(215,23,206)')
    dan = createChart('dan', 'Dan', 'rgb(215,23,206)')
    conan = createChart('conan', 'Conan', 'rgb(215,23,206)')

    function createChart(id, name, color) {
        let ctx = document.getElementById(id).getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Happy',
                    borderColor: 'rgb(162,255,127)',
                    data: []
                }, {
                    label: 'Angry',
                    borderColor: 'rgb(144,0,32)',
                    data: []
                }, {
                    label: 'Disgust',
                    borderColor: 'rgb(238,133,6)',
                    data: []
                }, {
                    label: 'Fear',
                    borderColor: 'rgb(182,180,180)',
                    data: []
                }, {
                    label: 'Sad',
                    borderColor: 'rgb(59,0,118)',
                    data: []
                }, {
                    label: 'Surprise',
                    borderColor: 'rgb(9,196,213)',
                    data: []
                }, {
                    label: 'Neutral',
                    borderColor: 'rgb(215,23,206)',
                    data: []
                }]
            },
            options: {
                title: {
                    display: true,
                    text: name
                },
                legend: {
                    display: false,
                    position: 'bottom'
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    }

    let colors = {
        'happy': 'rgb(162,255,127)',
        'angry': 'rgb(144,0,32)',
        'disgust': 'rgb(238,133,6)',
        'fear': 'rgb(182,180,180)',
        'sad': 'rgb(59,0,118)',
        'surprise': 'rgb(9,196,213)',
        'neutral': 'rgb(215,23,206)',
    }
</script>
</html>