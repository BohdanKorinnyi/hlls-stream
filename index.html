<html>

<head>
    <title>streaming test</title>
</head>

<body>
<script src="https://hls-js.netlify.app/dist/hls.js"></script>

<div style="text-align: center">
    <video id="video" style="width: 70%" controls></video>
    <input type="text" style="width: 50%; border: solid 1px black; margin-top: 5px; font-size: 20px"
           placeholder="Stream link" id="url">
    <input type="button" value="Apply" style="border: solid 1px #000000; font-size: 20px" id="set_url">
    <input type="checkbox" id="highlightState"> Highlight Speaker
    <p id="subtitles"></p>
</div>
<script>

    let colors = {
        1: 'blue',
        3: 'red',
        100: 'green'
    };

    var text = [];
    if (Hls.isSupported()) {
        var video = document.getElementById('video');
        var hls = new Hls();
        hls.loadSource('https://storage.googleapis.com/otopia_audio/conanZoom/ConanZoom.m3u8');
        hls.attachMedia(video);
        loadJSON(function (json) {
            let results = JSON.parse(json).response.results;
            let alternatives = results[results.length - 1].alternatives;
            for (let alternativeIndex = 0; alternativeIndex < alternatives.length; alternativeIndex++) {
                let words = alternatives[alternativeIndex].words;
                for (let wordIndex = 0; wordIndex < words.length; wordIndex++) {
                    text.push({
                        startTime: parseFloat(words[wordIndex].startTime.replace('s', '')),
                        endTime: parseFloat(words[wordIndex].endTime.replace('s', '')),
                        word: words[wordIndex].word,
                        speakerTag: words[wordIndex].speakerTag === undefined ? 100 : words[wordIndex].speakerTag
                    });
                }
            }
        })
        hls.on(Hls.Events.MANIFEST_PARSED, function () {
            video.play();
        });
    } else {
        alert("HLS is not supported in your browser")
    }

    let btn = document.getElementById('set_url');
    btn.addEventListener('click', function () {
        var hls = new Hls();
        hls.loadSource(document.getElementById('url').value);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function () {
            video.play();
        });
    }, false);

    let subtitles = document.getElementById('subtitles');

    window.setInterval(function () {
        var video = document.getElementById('video');
        if (text.length !== 0 && document.getElementById('highlightState').checked) {
            let currentTime = parseFloat(video.currentTime);
            subtitles.innerText = '';
            let speakerTag = text[0].speakerTag;
            let speakerText = '';
            for (let index = 0; index < text.length; index++) {
                if (text[index].endTime <= currentTime) {
                    if (speakerTag === text[index].speakerTag) {
                        speakerText += text[index].word + ' ';
                    } else {
                        subtitles.innerHTML += '<p style="color: ' + colors[speakerTag] + '">' + speakerText + '</p>';
                        speakerText = ''
                    }
                    speakerTag = text[index].speakerTag
                }
            }
            if (speakerText !== '') {
                subtitles.innerHTML += '<p style="color: ' + colors[speakerTag] + '">' + speakerText + '</p>';
            }
        } else if (text.length !== 0) {
            let foundText = null;
            let currentTime = parseFloat(video.currentTime);
            let line = '';
            subtitles.innerText = '';
            for (let index = 0; index < text.length; index++) {
                if (text[index].endTime <= currentTime) {
                    foundText = text[index].word;
                    line += ' ' + foundText;
                }
            }
            subtitles.innerText = line;
        }
    }, 100)

    function loadJSON(callback) {
        var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
        xobj.open('GET', 'ConanZoomTranscript.json', true);
        xobj.onreadystatechange = function () {
            if (xobj.readyState == 4 && xobj.status == "200") {
                callback(xobj.responseText);
            }
        };
        xobj.send(null);
    }
</script>
</body>
</html>